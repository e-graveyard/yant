variables:
  vmImageName: ubuntu-18.04


parameters:
  - name: nodeJsVersions
    type: object
    default: ['12.22', '14.18', '16.13', '17']


trigger:
  branches:
    include:
      - master
      - dev

  tags:
    include:
      - v*

  paths:
    exclude:
      - README.md


jobs:
  - ${{ each v in parameters.nodeJsVersions }}:
    - job:
      displayName: Validation (NodeJS ${{ v }})
      pool:
        vmImage: $(vmImageName)
      steps:
        - template: .ci/templates/node-with-modules.yml
          parameters:
            version: ${{ v }}

        - task: Bash@3
          inputs:
            targetType: inline
            script: npm run all
          displayName: Run all scripts

  - job: Test
    pool:
      vmImage: $(vmImageName)
    steps:
      - template: .ci/templates/node-with-modules.yml

      - template: .ci/templates/test.yml
        parameters:
          codecovToken: '$(codecovToken)'

  - job: Push
    pool:
      vmImage: $(vmImageName)
    dependsOn:
      - Test
    condition: |
      and
      (
        in(dependencies.Test.result, 'Succeeded'),
        startsWith(variables['Build.SourceBranch'], 'refs/tags/v')
      )

    steps:
      - task: Bash@3
        displayName: Create and push the Docker image
        inputs:
          targetType: filePath
          filePath: .ci/docker.sh
        env:
          imageName: caian/yant
          dockerHubPassword: '$(dockerHubPassword)'
